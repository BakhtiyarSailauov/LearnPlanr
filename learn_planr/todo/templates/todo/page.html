{% extends "todo/base.html" %}

{% block title %}{{ todo.title }}{% endblock %}

{% block content %}

<main class="main">
    <div class="container mt-5" style="background-color: #121212; padding: 30px; border-radius: 15px; box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.5);">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-white">{{ todo.title }}</h2>
            <a href="{% url 'todo:delete_todo' todo.id %}" class="btn btn-danger btn-sm">Удалить</a>
        </div>
        <p class="text-white">Создано: {{ todo.created_at }}</p>

        <h3 class="text-white">Список задач:</h3>
        <ul class="list-group">
            {% for task_data in chapters %}
            {% with task=task_data.task chapters=task_data.chapters %}
            <li class="list-group-item main-task {% if task_data.completed %}completed{% endif %}">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-white">{{ task.title }}</span>
                    <span class="deadline">{{ task.data_finish|date:"d.m.Y H:i" }}</span>
                </div>
                <!-- Add a button to toggle the task completion status -->
                <span id="toggle-subtasks-{{ task.id }}" class="text-white float-right">&#9660;</span>
                <!-- Add a class to the sub-tasks div for styling -->
                <div id="sub-tasks-{{ task.id }}" class="sub-tasks main-task-sub-tasks" style="display: none;">
                    <ul class="list-group">
                        {% for task_data in chapters %}
                        {% with task=task_data.task chapters=task_data.chapters %}
                        <!-- Add a class to the sub-task items for styling -->
                        <li class="list-group-item sub-task {% if task.completed %}completed{% endif %}">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-white">{{ task_data.title }}</span>
                                <span class="deadline">{{ task_data.data_finish|date:"d.m.Y H:i" }}</span>
                            </div>
                            <!-- Add a button to toggle the sub-task completion status -->
                            {% if task_data.completed %}
                            <button id="toggle-task-{{ task_data.id }}" class="btn btn-secondary btn-sm float-right" disabled>Выполнено</button>
                            {% elif not task_data.completed and forloop.first or task_data.next_button_enabled %}
                            <button id="toggle-task-{{ task_data.id }}" class="btn btn-success btn-sm float-right toggle-task first-task" data-completed="{% if task_data.completed %}true{% else %}false{% endif %}">Не выполнено</button>
                            {% else %}
                            <button id="toggle-task-{{ task_data.id }}" class="btn btn-success btn-sm float-right toggle-task" disabled>Не выполнено</button>
                            {% endif %}
                        </li>
                        {% endwith %}
                        {% endfor %}
                    </ul>
                </div>
            </li>
            {% endwith %}
            {% endfor %}
        </ul>

        <a href="{% url 'todo:get_todos' %}" class="btn btn-primary mt-3">Назад к списку</a>
    </div>
</main>

<style>
    /* Style for the main task items */
    .main-task {
        margin-bottom: 10px;
        background-color: #333;
        border: 1px solid #555;
        padding: 10px;
        border-radius: 5px;
        position: relative;
    }

    /* Style for deadlines */
    .deadline {
        background-color: #ff9900;
        color: #fff;
        padding: 3px 8px;
        border-radius: 3px;
    }

    /* Style for completed main task items */
    .main-task.completed {
        background-color: #555;
    }

    /* Style for sub-tasks container */
    .main-task-sub-tasks {
        background-color: #444;
        border-radius: 5px;
        margin-top: 10px;
        padding: 10px;
        display: none;
    }

    /* Style for sub-task items */
    .sub-task {
        margin-bottom: 5px;
        background-color: #222;
        border: 1px solid #444;
        padding: 5px;
        border-radius: 3px;
    }

    /* Style for completed sub-task items */
    .sub-task.completed {
        background-color: #444;
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var csrfToken = getCookie('csrftoken');

        // Обработчик для треугольника
        $('[id^="toggle-subtasks-"]').click(function () {
            var subtasks = $(this).parent().find('div.sub-tasks');
            subtasks.toggle();
        });

        // Обработчик для кнопки "Не выполнено" / "Выполнено"
        $('.toggle-task').click(function () {
            var taskId = $(this).attr('id').split('-')[2];
            var taskStatus = $(this).text();
            var firstBtn = $('#toggle-task-' + taskId).data('completed');
            if (taskStatus === 'Не выполнено' || taskStatus === 'Выполнено') {
                $.ajax({
                    url: '{% url "todo:toggle_task_completion" %}',
                    type: 'POST',
                    data: {
                        'task_data_id': taskId,
                        'first_btn': firstBtn,
                        'csrfmiddlewaretoken': csrfToken,
                    },
                    success: function (data) {
                        if (taskStatus === 'Не выполнено') {
                            $('#toggle-task-' + taskId).removeClass('btn-success').addClass('btn-danger').text('Выполнено');
                        } else {
                            $('#toggle-task-' + taskId).removeClass('btn-danger').addClass('btn-success').text('Не выполнено');
                        }
                    },
                    error: function () {
                        alert('An error occurred while updating task completion status.');
                    }
                });
            }

            // Enable the next task button
            var nextTaskButton = $(this).closest('li').next().find('.toggle-task');
            if (nextTaskButton.length > 0) {
                nextTaskButton.prop('disabled', false);
            }
        });
    });
</script>



{% endblock %}
